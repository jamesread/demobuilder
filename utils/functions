#!/bin/bash

. config

cache() {
  DEST=cache/$(echo $1 | sed -e 's!.*://!!')
  if ! [ -e $DEST ]; then
    mkdir -p $(dirname $DEST)
    curl -o $DEST $1 

	if [ $? -ne 0 ]; then
		>&2 echo "CURL exited with nonzero exit code, which probably means it could not download and cache a file: $1 --> $DEST"
		exit 1
	fi
  fi
  echo $DEST
}

interface_ip() {
  ifconfig $1 | awk '/inet / { print $2; }'
}

proxy_start() {
  eval $(utils/yumproxy.py $(interface_ip $BRIDGE))
  export PROXYLISTENER
}

proxy_stop() {
  kill $PROXYPID
}

httpserver_start() {
  eval $(utils/httpserver.py $(interface_ip $BRIDGE))
  export HTTPLISTENER
}

httpserver_stop() {
  kill $HTTPPID
}

compress_qcow2() {
  BACKINGFILE=$(qemu-img info $1 | sed -n -e '/^backing file: / { s/.*: //; p; }')

  if [ -z $BACKINGFILE ]; then
    qemu-img convert -cp -O qcow2 $1 $1.tmp
  else
    qemu-img convert -cp -O qcow2 -B $BACKINGFILE $1 $1.tmp
  fi

  mv $1.tmp $1
}

flatten_qcow2() {
  qemu-img convert -cp -O qcow2 $1 $1.tmp
  mv $1.tmp $1
}

wait_pid() {
  while [ -e /proc/$1 ]; do
    sleep 1
  done
}

if [ "$DEBUG" ]; then
  set -x
fi

require_proxy() {
  if [ -z "$PROXYLISTENER" ]; then
    echo "Proxy listener is not defined";
  fi
}

require_httplistener() {
  if [ -z "$HTTPLISTENER" ]; then
    echo "HTTP listener is not defined.";
	exit 1
  fi
}

require_bridge(){ 
  if [ -z "$BRIDGE" ]; then
    echo "bridge is not set"
	exit1
  fi
}

require_keys() {
  if [ ! -e keys/demobuilder.pub ]; then
    echo "keys have not been created"
	exit 1
 fi
}
